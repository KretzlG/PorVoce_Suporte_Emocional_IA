<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{% block title %}Dashboard - Por Você{% endblock %}</title>
	
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<!-- CSS customizado -->
	<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='dashboards/css/dashboard-base.css') }}">
	
	<!-- CSS para evitar piscada e melhorar layout -->
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		html, body {
			height: 100%;
			background-color: #f8f9fa !important;
			overflow-x: hidden;
		}
		
		.page-wrapper {
			min-height: 100vh;
			background-color: #f8f9fa;
		}
		
		.left-sidebar {
			position: fixed;
			top: 0;
			left: 0;
			z-index: 1000;
			height: 100vh;
			overflow-y: auto;
			transition: none;
		}
		
		.main-content {
			margin-left: 250px;
			min-height: 100vh;
		}
		
		/* Para usuários não logados, não mostrar margem */
		.no-sidebar .main-content {
			margin-left: 0;
		}
		
		.nav-link:hover {
			background-color: rgba(255,255,255,0.1) !important;
		}
		
		.card {
			border: none !important;
			box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075) !important;
		}
		
		.bg-light-primary { background-color: rgba(13,110,253,0.1) !important; }
		.bg-light-success { background-color: rgba(25,135,84,0.1) !important; }
		.bg-light-info { background-color: rgba(13,202,240,0.1) !important; }
		.bg-light-danger { background-color: rgba(220,53,69,0.1) !important; }
		.bg-light-warning { background-color: rgba(255,193,7,0.1) !important; }
		
		/* Evitar piscada */
		canvas {
			max-height: 400px !important;
			height: auto !important;
		}
		
		/* Layout responsivo */
		@media (max-width: 768px) {
			.left-sidebar {
				margin-left: -250px;
			}
			.main-content {
				margin-left: 0;
			}
		}
	</style>
	{% block extra_css %}{% endblock %}
</head>
<body class="{% if not current_user.is_authenticated %}no-sidebar{% endif %}">

<div class="page-wrapper d-flex" id="main-wrapper">
	{% if current_user.is_authenticated %}
		<!-- Sidebar Premium Style -->
		<aside class="left-sidebar sidebar bg-primary text-white d-flex flex-column" id="sidebar" style="width:250px;min-height:100vh;transition:all 0.3s cubic-bezier(.4,2,.6,1);box-shadow:4px 0 16px rgba(0,0,0,0.07);border-top-right-radius:24px;border-bottom-right-radius:24px;">
			<div class="brand-logo p-4 border-bottom border-light d-flex align-items-center justify-content-between">
				<div class="d-flex align-items-center gap-2">
					<i class="fas fa-heart text-white"></i>
					<span class="fw-bold fs-5 text-white">Por Você</span>
				</div>
				<button id="sidebar-toggle-close" class="btn btn-outline-light btn-sm d-lg-none" type="button" title="Fechar menu">
					<i class="fas fa-times"></i>
				</button>
			</div>
			<nav class="p-3 flex-grow-1">
				<ul class="nav flex-column gap-2">
					{% if current_user.is_admin %}
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('admin.dashboard') }}">
								<i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('admin.users') }}">
								<i class="fas fa-users"></i> <span>Usuários</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('training.index') }}">
								<i class="fas fa-robot"></i> <span>Treinar IA</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('admin.analytics') }}">
								<i class="fas fa-chart-line"></i> <span>Analytics</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('chat.chat_interface') }}">
								<i class="fas fa-comments"></i> <span>Chat</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('admin.settings') }}">
								<i class="fas fa-cog"></i> <span>Configurações</span>
							</a>
						</li>
					{% elif current_user.is_client %}
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('main.dashboard') }}">
								<i class="fas fa-home"></i> <span>Meu Espaço</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('chat.chat_interface') }}">
								<i class="fas fa-comments"></i> <span>Conversar</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('diary.diary_interface') }}">
								<i class="fas fa-book"></i> <span>Diário Emocional</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('main.help_page') }}">
								<i class="fas fa-question-circle"></i> <span>Ajuda</span>
							</a>
						</li>
					{% elif current_user.is_volunteer %}
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('volunteer.dashboard') }}">
								<i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('chat.chat_interface') }}">
								<i class="fas fa-comments"></i> <span>Chat</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="/volunteer/new_service" title="Iniciar novo atendimento">
								<i class="fas fa-headset"></i> <span>Novo Atendimento</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('training.index') }}">
								<i class="fas fa-robot"></i> <span>Treinar IA</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link text-white fw-semibold rounded-pill px-3 py-2 d-flex align-items-center gap-2" href="{{ url_for('main.help_page') }}">
								<i class="fas fa-question-circle"></i> <span>Ajuda</span>
							</a>
						</li>
					{% endif %}
				</ul>
			</nav>
		</aside>
	{% endif %}
	
	<!-- Main Content Area -->
	<div class="main-content flex-grow-1 d-flex flex-column" style="min-height:100vh;">
		<!-- Topbar -->
		{% if current_user.is_authenticated %}
			<nav class="navbar navbar-expand-lg bg-white shadow-sm px-4 py-3 border-bottom">
				<div class="container-fluid">
					<!-- Botão hamburger para esconder/mostrar sidebar -->
					<button id="sidebar-toggle" class="btn btn-outline-primary me-3" type="button" style="display:inline-flex;align-items:center;">
						<i class="fas fa-bars"></i>
					</button>
					<div class="navbar-nav ms-auto align-items-center">
						<div class="nav-item dropdown">
							<a class="nav-link dropdown-toggle d-flex align-items-center gap-2 text-dark" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
								<i class="fas fa-user-circle fs-5"></i>
								<span>
									{{ current_user.nome or current_user.get_full_name() or current_user.first_name or current_user.username or current_user.email or 'Usuário' }}
								</span>
							</a>
							<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
								<li><a class="dropdown-item" href="{{ url_for('perfil.perfil') }}"><i class="fas fa-user me-2"></i>Perfil</a></li>
								<li><hr class="dropdown-divider"></li>
								<li><a class="dropdown-item" href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
							</ul>
						</div>
					</div>
				</div>
			</nav>
		{% endif %}
		
		<!-- Page Content -->
		<main class="flex-grow-1 p-4" style="background-color:#f8f9fa;overflow-x:auto;">
			{% block page_title %}{% endblock %}
			{% block dashboard_content %}{% endblock %}
		</main>
	</div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Scripts customizados -->
<script src="{{ url_for('static', filename='js/base.js') }}"></script>
<script src="{{ url_for('static', filename='dashboards/js/dashboard-base.js') }}"></script>
<script src="{{ url_for('static', filename='dashboards/js/charts.js') }}"></script>
<script>
function checkWaitingClients() {
    fetch('/api/triage/waiting')
        .then(response => response.json())
        .then(data => {
            if (data.waiting_count > 0) {
                const atendimentoBtn = document.querySelector('.fa-headset').closest('a');
                if (atendimentoBtn) {
                    atendimentoBtn.classList.remove('disabled');
                    atendimentoBtn.setAttribute('href', '/volunteer/new_service');
                    atendimentoBtn.setAttribute('title', 'Novo atendimento disponível!');
                }
                showWaitingAlert(data.waiting_count);
            }
        });
}
function showWaitingAlert(count) {
    if (!document.getElementById('waiting-alert')) {
        const alertDiv = document.createElement('div');
        alertDiv.id = 'waiting-alert';
        alertDiv.className = 'alert alert-warning position-fixed top-0 end-0 m-4 shadow';
        alertDiv.style.zIndex = '2000';
        alertDiv.innerHTML = `<strong>Há ${count} atendimento(s) aguardando!</strong> <i class='fas fa-bell fa-shake'></i>`;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 10000);
    }
}
setInterval(checkWaitingClients, 10000);
window.addEventListener('DOMContentLoaded', checkWaitingClients);
</script>
{% block extra_js %}{% endblock %}

</body>
</html>
